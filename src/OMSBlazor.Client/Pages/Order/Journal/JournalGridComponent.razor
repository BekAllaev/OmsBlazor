@using OMSBlazor.Dto.Customer
@using OMSBlazor.Dto.Employee
@using System.Collections.ObjectModel

@if (Device != Device.Smartphone && Device != Device.Desktop)
{
    <div class="d-flex flex-row align-center align-self-start mb-2">
        <MudText>Show hidden columns:</MudText>
        <MudTooltip Text="Show/hide columns related to ship info and order date">
            <MudSwitch @bind-Value="isColumnVisible" Color="MudBlazor.Color.Primary" />
        </MudTooltip>
    </div>
}

<MudDataGrid T="SelectableOrderDto" Dense="true" Elevation="3" RowsPerPage="25" RowClass="cursor-pointer"
    RowClick="e=>FireOnRowClicked(e.Item.SourceOrderDto.OrderId)" Style="width:100%" Items="Orders"
    RowStyleFunc="RowStyleFunc" Hover="true" Striped="true" Bordered="true">
    <ColGroup>
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
    </ColGroup>
    <Columns>
        <PropertyColumn Property="x => x.SourceOrderDto.OrderId" Title="Id" Sortable="false"
            HeaderClassFunc="_ => GetHeaderClass()" />
        <TemplateColumn Title="Customer" CellClass="cell-style" HeaderClassFunc="_ => GetHeaderClass()">
            <CellTemplate>
                <MudText>
                    @Customers.Single(x => x.CustomerId == context.Item.SourceOrderDto.CustomerId).CompanyName
                </MudText>
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Employee" CellClass="cell-style" HeaderClassFunc="_ => GetHeaderClass()">
            <CellTemplate>
                <MudText>
                    @Employees.Single(x => x.EmployeeId == context.Item.SourceOrderDto.EmployeeId).FirstName
                    @Employees.Single(x =>
                             x.EmployeeId == context.Item.SourceOrderDto.EmployeeId).LastName
                </MudText>
            </CellTemplate>
        </TemplateColumn>
        <PropertyColumn Property="x => x.SourceOrderDto.OrderDate" Hidden="IsColumnHidden(Column.OrderDate)" Format="dd/MM/yyyy"
            Title="Order date" HeaderClassFunc="_ => GetHeaderClass()" />
        <PropertyColumn Property="x=>x.SourceOrderDto.ShipName" Hidden="IsColumnHidden(Column.ShipName)" Title="Ship name"
            CellClass="cell-style" HeaderClassFunc="_ => GetHeaderClass()" />
        <PropertyColumn Property="x=>x.SourceOrderDto.ShipCity" Hidden="IsColumnHidden(Column.ShipCity)" Title="Ship city"
            HeaderClass="cell-style" HeaderClassFunc="_ => GetHeaderClass()" />
        <PropertyColumn Property="x=>x.SourceOrderDto.ShipCountry" Hidden="IsColumnHidden(Column.ShipCountry)" Title="Ship country"
            HeaderClass="cell-style" HeaderClassFunc="_ => GetHeaderClass()" />
        @if (Device != Device.Smartphone)
        {
            <TemplateColumn HeaderClassFunc="_ => GetHeaderClass()" CellClass="text-center">
                <CellTemplate>
                    <MudButton Size="@MudBlazor.Size.Small" Variant="@Variant.Filled" Color="@MudBlazor.Color.Primary"
                        OnClick="() => FireOnShowInvoiceClicked(context.Item.SourceOrderDto.OrderId)">Invoice</MudButton>
                </CellTemplate>
            </TemplateColumn>
        }
        <TemplateColumn HeaderClassFunc="_ => GetHeaderClass()" CellClass="d-flex justify-center">
            <CellTemplate>
                @if (context.Item.SourceOrderDto.PaymentId is null)
                {
                    <MudButton Class="align-self-center" Size="@MudBlazor.Size.Small" Variant="@Variant.Filled"
                        Color="@MudBlazor.Color.Primary"
                        OnClick="()=>FireOnPayClicked(context.Item.SourceOrderDto.OrderId)">Pay</MudButton>
                }
                else
                {
                    <MudAlert Severity="Severity.Success" Dense="true" Variant="Variant.Filled" NoIcon="true" Square="true"
                        ContentAlignment="HorizontalAlignment.Center">Paid</MudAlert>
                }
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="SelectableOrderDto" />
    </PagerContent>
</MudDataGrid>

<style>
    .cell-style {
        overflow-x: hidden;
        white-space: nowrap;
    }

    .dark-mode-header-style {
        background-color: gray;
        overflow-x: hidden;
        white-space: nowrap;
    }


    .light-mode-header-style {
        background-color: lightgray;
        overflow-x: hidden;
        white-space: nowrap;
    }

    .text-center {
      text-align: center;
    }
</style>

@code {
    [Parameter]
    public Device Device { get; set; }

    [Parameter]
    public bool IsDarkMode { get; set; }

    [Parameter]
    public ReadOnlyObservableCollection<SelectableOrderDto> Orders { get; set; }

    [Parameter]
    public List<CustomerDto> Customers { get; set; }

    [Parameter]
    public List<EmployeeDto> Employees { get; set; }

    [Parameter]
    public EventCallback<int> OnRowClicked { get; set; }

    [Parameter]
    public EventCallback<int> OnShowInvoiceClicked { get; set; }

    [Parameter]
    public EventCallback<int> OnPayClicked { get; set; }

    private bool IsColumnHidden(Column column)
    {
        switch (column)
        {
            case Column.OrderDate:
                return Device switch
                {
                    Device.Tablet => !isColumnVisible,
                    _ => false
                };
            case Column.ShipCity:
            case Column.ShipCountry:
                return Device switch
                {
                    Device.Smartphone => true,
                    Device.Desktop => false,
                    _ => !isColumnVisible
                };
            case Column.ShipName:
                return Device switch
                {
                    Device.Smartphone => true,
                    Device.Desktop or Device.Laptop => false,
                    _ => !isColumnVisible
                };
            default:
                return false;
        }
    }

    private bool isColumnVisible = false;

    private Task FireOnPayClicked(int orderId)
    {
        return OnPayClicked.InvokeAsync(orderId);
    }

    private Task FireOnRowClicked(int orderId)
    {
        return OnRowClicked.InvokeAsync(orderId);
    }

    private Task FireOnShowInvoiceClicked(int orderId)
    {
        return OnShowInvoiceClicked.InvokeAsync(orderId);
    }

    private string RowStyleFunc(SelectableOrderDto selectableOrder, int index)
    {
        if (selectableOrder.IsSelcted)
        {
            return $"background-color: {MudBlazor.Colors.DeepOrange.Lighten1}";
        }
        else
        {
            return string.Empty;
        }
    }

    private string GetHeaderClass()
    {
        if (IsDarkMode)
        {
            return "dark-mode-header-style";
        }
        else
        {
            return "light-mode-header-style";
        }
    }

    enum Column
    {
        OrderDate,
        ShipCity,
        ShipCountry,
        ShipName
    }
}